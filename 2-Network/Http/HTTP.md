## HTTP的本质
它是一个客户端（Client）和服务器端（Server）之间请求和应答的标准协议，基于TCP/IP协议实现，协议对于事务处理没有记忆能力，每次请求都是独立的。

## 协议改进
HTTP/0.9（1991年）：最早期版本，只支持GET请求
HTTP/1.0（1996年）：添加了POST、HEAD方法，增加了响应状态码
HTTP/1.1（1997年）：引入持久连接，管道机制等
HTTP/2.0（2015年）：多路复用，服务器推送等新特性
HTTP/3.0（最新）：基于QUIC协议，进一步提升性能

### 持久连接
引入背景：
在HTTP/1.0中，每个HTTP请求都需要建立一个新的TCP连接，TCP连接的建立需要三次握手，断开需要四次挥手，对于一个网页来说，可能需要请求多个资源（HTML、CSS、JS、图片等），频繁建立和断开TCP连接会导致服务器资源消耗。
解决方案：
HTTP/1.1引入持久连接，默认开启，在一个TCP连接上可以传送多个HTTP请求和响应。通过Connection头部字段控制：
```
Connection: keep-alive  // 保持连接
Connection: close      // 关闭连接
```
优势：
- 减少TCP连接建立和断开的开销
- 避免TCP慢启动导致的性能损失
- 降低了服务器的负载
- 提高了页面加载速度

使用持久连接于非持久连接
```
tcpdump -i lo port 8080 -w connect-1.pcap
tcpdump -i lo port 8080 -w connect-2.pcap
```
```
# tcpdump 输出（简化后）
# 只会看到一次 TCP 三次握手
> TCP SYN
< TCP SYN-ACK
> TCP ACK
# 后续是 HTTP 数据传输
> PSH HTTP GET
< PSH HTTP 200 OK
> PSH HTTP GET
< PSH HTTP 200 OK
...
# 最后一次请求完成后一段时间才会断开连接
```
```
# tcpdump 输出（简化后）
# 每个请求都会有完整的 TCP 连接建立和断开过程
> TCP SYN
< TCP SYN-ACK
> TCP ACK
> PSH HTTP GET
< PSH HTTP 200 OK
> FIN
< FIN-ACK
> ACK

> TCP SYN
< TCP SYN-ACK
...（重复5次）
```

### 管道机制
引入背景：
即使有了持久连接，HTTP请求仍然是按顺序串行处理的,必须等待前一个请求响应完成才能发送下一个请求,这种"请求-响应-请求-响应"的模式会造成队头阻塞（Head-of-line blocking）
解决方案：
允许在同一个TCP连接中一次性发送多个HTTP请求,服务器必须按照请求的顺序返回响应,不用等待前一个响应就可以发送下一个请求。
```
不使用管道：
请求1 -> 响应1 -> 请求2 -> 响应2 -> 请求3 -> 响应3

使用管道：
请求1 -> 请求2 -> 请求3 -> 响应1 -> 响应2 -> 响应3
```
限制和问题：
- 管道机制仍然要求服务器按序返回响应
- 如果第一个请求处理时间很长，后面的请求响应也会被阻塞
- 不是所有类型的请求都能使用管道（如POST等非幂等请求）
- 很多服务器和代理并不能很好地支持管道

管道机制在实际应用中使用较少。促使HTTP/2.0引入了多路复用（Multiplexing）机制，HTTP/2.0的多路复用可以在一个连接中并行处理多个请求和响应，真正解决了队头阻塞问题。


### 多路复用
HTTP/1.1 存在的主要问题：
1. 队头阻塞（Head-of-Line Blocking）：
    - 虽然 HTTP/1.1 引入了持久连接
    - 但请求仍然需要按顺序发送和响应
    - 如果第一个请求处理时间长，后面的请求都会被阻塞
2. 并发连接限制：
    - 浏览器对同一域名的并发连接数有限制（通常是 6-8 个）
    - 为了突破限制，网站常常使用多域名（域名分片）来提升并发
2. 协议开销大：
    - 每个 HTTP 请求都会携带大量冗余的头信息
    - 每个连接都需要单独的 TCP 三次握手

多路复用的工作原理：
```
HTTP/1.1 的请求响应模型：
连接1：请求A -> 响应A -> 请求B -> 响应B
连接2：请求C -> 响应C -> 请求D -> 响应D

HTTP/2.0 的多路复用模型：
单个连接：
    请求A -----> 
    请求B -----> 
    请求C -----> 
    响应B <-----
    响应A <-----
    响应C <-----
```
核心概念：
1. 流（Stream）：
    - 建立在 TCP 连接上的虚拟通道
    - 每个请求-响应对对应一个流
    - 流是双向的，可以携带一个或多个消息
2. 消息（Message）：
    - 完整的请求或响应
    - 由一个或多个帧组成
3. 帧（Frame）：
    - HTTP/2.0 通信的最小单位
    - 包含帧头标识所属的流
    - 所有帧都在一个 TCP 连接上传输