# TCP
> TCP 的引入解决了网络通信的可靠性问题

## 引入背景
```
1. 网络不可靠：
   - 数据包丢失
   - 数据包重复
   - 数据包乱序
   - 数据包损坏

2. 网络异构：
   - 不同类型的网络
   - 不同的传输介质
   - 不同的传输速率

3. 通信需求：
   - 端到端可靠传输
   - 流量控制
   - 拥塞控制
```

## TCP的机制
```
1. 三次握手（建立连接）：
Client                    Server
  |          SYN          |
  |---------------------->|
  |       SYN + ACK       |
  |<----------------------|
  |          ACK          |
  |---------------------->|

2. 四次挥手（断开连接）：
Client                    Server
  |          FIN          |
  |---------------------->|
  |          ACK          |
  |<----------------------|
  |          FIN          |
  |<----------------------|
  |          ACK          |
  |---------------------->|
```

## TCP的本质
TCP 的本质是通过在通信双方各自维护一个基于四元组(源IP、源端口、目标IP、目标端口)的状态机，在不可靠的网络层之上，通过序列号、确认应答、超时重传、流量控制、拥塞控制等机制，模拟出一条可靠的虚拟数据通道，从而保证了应用层数据的可靠传输。这种设计既解决了 IP 层不可靠的问题，又为上层应用提供了简单统一的接口。

## TCP重要特性
```
1. 面向连接：
   - 通信前需要建立连接
   - 通信结束要断开连接
   - 一对一通信

2. 可靠传输：
   - 确认机制
   - 重传机制
   - 校验和机制

3. 流量控制：
   - 滑动窗口
   - 接收窗口大小通告

4. 拥塞控制：
   - 慢启动
   - 拥塞避免
   - 快重传
   - 快恢复
```

## 异常场景
连接建立阶段：
```
A. SYN 丢失：
Client         [X]         Server
  | ----SYN---->X            |
  |     超时重传              |
  | ----SYN---->             |
  
B. SYN+ACK 丢失：
Client                    Server
  | ----SYN---->             |
  |                          |
  |        X<----SYN+ACK---- |
  |     超时重传              |
  | ----SYN---->             |

C. ACK 丢失：
Client                    Server
  | ----SYN---->             |
  | <---SYN+ACK----          |
  | ----ACK----->X           |
  |         服务端超时重传    |
  | <---SYN+ACK----          |
```
数据传输阶段异常：
```
A. 数据包丢失：
  - 发送方数据包丢失
  - 接收方 ACK 丢失
  - 重传超时（RTO）触发重传

B. 数据包乱序：
  发送：1 -> 2 -> 3 -> 4
  接收：1 -> 3 -> 2 -> 4
  处理：缓存乱序数据，等待缺失包

C. 数据包重复：
  发送方：原包 -> 重传包
  接收方：通过序列号去重

D. 数据包损坏：
  - 校验和错误
  - 接收方丢弃并等待重传
```
流量控制相关异常：
```
A. 接收窗口为零：
  - 发送方停止发送
  - 周期性发送窗口探测包

B. 接收缓冲区溢出：
  - 丢弃新来的数据包
  - 通告窗口大小为0

C. 窗口更新包丢失：
  - 可能导致死锁
  - 需要定时探测机制
```
拥塞控制相关异常：
```
A. 网络拥塞：
  - 包丢失率增加
  - RTT 增大
  处理：
  - 减小拥塞窗口
  - 进入拥塞避免阶段

B. 突发流量：
  - 缓冲区溢出
  - 丢包增多
  处理：
  - 启动慢启动机制
  - 调整拥塞窗口

C. 网络抖动：
  - RTT 波动
  - 虚假重传
  处理：
  - 自适应 RTO
  - SACK 选择性确认
```
连接终止阶段（四次挥手）异常：
```
A. FIN 包丢失：
发送方                    接收方
  | ----FIN----->X          |
  |        超时重传          |
  | ----FIN----->           |

B. ACK 丢失：
  - FIN 的 ACK 丢失
  - 重传 FIN 包
  
C. 半关闭状态卡住：
  - TIME_WAIT 状态异常
  - CLOSE_WAIT 状态异常
```

## TCP这种状态机的缺陷
1. SYN Flood攻击
```
攻击原理：
Client                    Server
  |    SYN (伪造源IP)      |
  | -------------------> | 分配资源
  |    SYN (伪造源IP)      | 等待响应
  | -------------------> | 分配资源
  |    SYN (伪造源IP)      | 资源耗尽
  | -------------------> |

危害：
- 服务器为每个 SYN 分配资源
- 半连接队列被占满
- 正常用户无法建立连接

防护措施：
- SYN Cookie
- 调整半连接队列大小
- 启用 tcp_syncookies
```
2. RST攻击：
```
攻击原理：
Client      Attacker      Server
  |            |            |
  |<---正常通信--->|            |
  |            |--RST伪造-->|
  |            |            | 连接重置

危害：
- 已建立的连接被强制断开
- 服务中断

防护措施：
- TCP MD5 认证
- 序列号验证
- 防火墙过滤
```
3. 会话劫持：
```
攻击原理：
Client      Attacker      Server
  |            |            |
  |<---正常通信--->|            |
  |            |--伪造数据-->|
  |            |<--响应-----|

危害：
- 插入恶意数据
- 窃取敏感信息

防护措施：
- 使用 TLS/SSL
- TCP MD5 认证
- IPSec
```
4. ACK 泛洪：
```
攻击原理：
发送大量伪造的 ACK 包
服务器需要验证每个 ACK

防护措施：
- 状态检查
- 速率限制
- 防火墙过滤
```
## 缺陷的归因
连接建立时的信任问题：
```
设计初衷：
- 假设网络环境是善意的
- 注重通信双方的握手确认
- 优先考虑可靠性而非安全性

问题：
- 服务器先付出资源（分配连接资源）
- 客户端后付出资源（最后一次ACK）
- 这种不对等导致了 SYN Flood 攻击
```
状态维护的资源消耗：
```
设计初衷：
- 为保证可靠传输必须维护连接状态
- 每个连接都需要独立的资源

带来的问题：
- 服务器需要为每个连接分配资源
- 状态信息可被伪造和利用
- 资源有限而攻击成本低
```
地址验证的缺陷:
```
设计初衷：
- 基于 IP 地址识别通信双方
- 假设 IP 地址是可信的

问题：
- IP 地址易被伪造
- 无法验证数据包的真实来源
- 导致了 IP 欺骗类攻击
```