# HTTPS
TLS（传输层安全协议）通过多个安全机制来保证通信安全。

## 加密-保证通信的安全
```
对称加密：
- 用于加密实际传输的数据
- 常用算法：AES-256-GCM, ChaCha20-Poly1305
- 过程：
  Client ----[对称密钥加密]----> Server
  明文数据 -> 加密 -> 密文 -> 解密 -> 明文数据

非对称加密：
- 用于交换对称密钥
- 常用算法：RSA, ECDSA
- 过程：
  1. 服务器持有公钥和私钥
  2. 客户端使用公钥加密对称密钥
  3. 服务器使用私钥解密获得对称密钥
```
## 身份认证-保证通信双方身份
```
数字证书机制：
1. 证书包含：
   - 服务器的公钥
   - 服务器的身份信息
   - CA的数字签名

2. 验证过程：
   Client                                Server
     |                                     |
     |     请求连接                         |
     | ----------------------------------> |
     |                                     |
     |     发送数字证书                     |
     | <---------------------------------- |
     |                                     |
     | 验证步骤：                           |
     | 1. 检查证书是否过期                  |
     | 2. 验证CA签名                       |
     | 3. 检查证书域名                     |
```
证书信任链验证:
```
信任链结构：
根CA证书 -> 中间CA证书 -> 服务器证书

验证过程：
1. 服务器证书 -> 由中间CA签发
2. 中间CA证书 -> 由根CA签发
3. 根CA证书 -> 预置在操作系统/浏览器中
```
## 完整性检查-防止数据被篡改
```
消息认证码（MAC）：
1. HMAC（Hash-based Message Authentication Code）
   - 结合哈希函数（如SHA-256）和密钥
   - 过程：
     数据 + 密钥 -> HMAC算法 -> MAC值

2. 验证过程：
   发送方：
   数据 + MAC -> 接收方
   
   接收方：
   1. 计算收到数据的MAC
   2. 对比收到的MAC
   3. 如果不匹配，说明数据被篡改
```
## 防重放攻击
```
使用序列号和时间戳：
1. 每个消息都有唯一序列号
2. 接收方维护滑动窗口
3. 丢弃重复的序列号
4. 检查时间戳是否在允许范围内

示例：
Client                                Server
  |                                     |
  | Seq=1, Data="Hello"                 |
  | ----------------------------------> |
  |                                     |
  | Seq=2, Data="World"                 |
  | ----------------------------------> |
  |                                     |
  | 攻击者重放Seq=1                     |
  | ----------------------------------> | [丢弃]
```
## 完美前向保密
```
使用临时密钥：
1. 每个会话使用不同的临时密钥
2. 即使长期密钥泄露，之前的通信仍然安全

实现方式（DHE或ECDHE）：
Client                                Server
  |                                     |
  |   ClientHello + 客户端随机数         |
  | ----------------------------------> |
  |                                     |
  |   ServerHello + 服务器随机数         |
  |   + DH参数                          |
  | <---------------------------------- |
  |                                     |
  |   计算会话密钥                       |
  |   = F(客户端随机数,服务器随机数,DH密钥) |
```

## 请求过程
```
https://www.baidu.com 访问流程：

1. 检查 HSTS 预加载列表 ✓
2. DNS 解析获取 IP
3. 建立 TCP 连接
4. TLS 握手：
   - 验证证书是否为 baidu.com
   - 验证证书链
   - 验证证书有效性
5. 建立加密通道
6. 发送 HTTP 请求
```
## 其余防护手段
HSTS 预加载
证书透明度检查
域名信誉系统
